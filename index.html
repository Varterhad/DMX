<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DMX Калькулятор</title>
    
    <!-- PWA настройки -->
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DMX Калькулятор">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #000000;
            color: #ffffff;
            line-height: 1.4;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            overscroll-behavior: none;
            -webkit-touch-callout: none;
            height: 100%;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* Полноэкранный режим */
        @media (display-mode: standalone), (display-mode: fullscreen) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .equipment-header {
                padding-top: calc(8px + env(safe-area-inset-top));
                height: calc(52px + env(safe-area-inset-top));
            }
        }
        
        button {
            font-family: inherit;
            cursor: pointer;
            outline: none;
            border: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        input {
            font-family: inherit;
        }
        
        /* ОСНОВНОЙ КОНТЕЙНЕР */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 20px;
            min-height: 100vh;
            width: 100%;
        }
        
        /* ЗАГОЛОВОК ОБОРУДОВАНИЯ */
        .equipment-header {
            background-color: #333333;
            height: 52px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .equipment-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-align: left;
            flex: 1;
            height: 100%;
            cursor: pointer;
            padding: 0;
        }
        
        /* ЗАКРЕПЛЕННОЕ ОБОРУДОВАНИЕ */
        .pinned-container {
            background-color: #222222;
            padding: 8px 16px;
            display: none;
        }
        
        .pinned-item {
            background-color: #333333;
            border-radius: 4px;
            padding: 6px 8px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            height: 32px;
        }
        
        .pinned-item-text {
            flex: 1;
            font-size: 12px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .unpin-btn {
            background: none;
            border: none;
            color: #FF5555;
            font-size: 14px;
            font-weight: bold;
            padding: 0 10px;
            cursor: pointer;
        }
        
        /* СЕКЦИЯ АДРЕСА */
        .address-section {
            padding: 16px 8px 0 8px;
        }
        
        .address-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .round-btn {
            width: 56px;
            height: 56px;
            border-radius: 8px;
            border: none;
            background-color: #666666;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .address-display {
            flex: 1;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4CAF50;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
        }
        
        .surrounding-addresses {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 12px 16px 0 16px;
            gap: 8px;
        }
        
        .address-group {
            flex: 1;
            display: flex;
            gap: 8px;
        }
        
        .address-group span {
            flex: 1;
            text-align: center;
            color: #AAAAAA;
            font-size: 12px;
            min-width: 30px;
        }
        
        .arrows {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .arrow {
            color: #666666;
            font-size: 14px;
        }
        
        .empty-space {
            width: 40px;
            height: 28px;
        }
        
        /* СЕКЦИЯ ВВОДА */
        .input-section {
            margin: 16px 0;
            padding: 0 16px;
        }
        
        .input-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .input-label {
            color: white;
            font-size: 16px;
            font-weight: bold;
            width: 60px;
            text-align: right;
            padding-right: 8px;
        }
        
        .number-input {
            width: 100px;
            height: 60px;
            background-color: #333333;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            padding: 12px 8px;
        }
        
        .number-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #4CAF50;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .divider {
            height: 1px;
            background-color: #444444;
            margin: 16px 16px;
        }
        
        /* КНОПКИ ПИНОВ */
        .pins-section {
            margin: 0 8px 16px 8px;
        }
        
        .pins-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            justify-content: center;
            width: 100%;
        }
        
        .pin-btn {
            flex: 1;
            height: 60px;
            border: none;
            border-radius: 6px;
            background-color: #F44336;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            min-width: 0;
            min-height: 60px;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        .pin-btn.selected {
            background-color: #4CAF50;
        }
        
        /* РЕЗУЛЬТАТ */
        .result-text {
            text-align: center;
            color: #4CAF50;
            font-size: 14px;
            font-weight: bold;
            line-height: 1.6;
            margin-bottom: 16px;
            padding: 0 16px;
            min-height: 40px;
        }
        
        .reset-btn {
            display: block;
            margin: 0 auto;
            height: 40px;
            padding: 0 16px;
            border: none;
            border-radius: 8px;
            background-color: #FF9800;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ПАНЕЛЬ ОБОРУДОВАНИЯ */
        .equipment-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333333;
            z-index: 1000;
            overflow-y: auto;
            display: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .equipment-panel-header {
            display: flex;
            justify-content: flex-end;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            background-color: #333333;
            z-index: 10;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px;
        }
        
        .search-input {
            display: block;
            width: calc(100% - 32px);
            margin: 0 16px 8px 16px;
            padding: 10px 12px;
            background-color: #444444;
            border: 1px solid #666666;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        
        .search-input::placeholder {
            color: #888888;
        }
        
        .add-equipment-btn {
            display: block;
            width: calc(100% - 32px);
            margin: 0 16px 8px 16px;
            height: 48px;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            background-color: #222222;
            color: #4CAF50;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .equipment-list-container {
            padding: 0 16px 16px 16px;
        }
        
        .equipment-item {
            background-color: #444444;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            min-height: 44px;
        }
        
        .equipment-item-text {
            flex: 1;
            color: white;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .edit-btn, .pin-star-btn {
            background: none;
            border: none;
            color: #4CAF50;
            font-size: 14px;
            padding: 0 8px;
            min-width: 40px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .pin-star-btn.pinned {
            color: #FFD700;
        }
        
        /* ДИАЛОГОВОЕ ОКНО */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .dialog {
            background-color: #333333;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }
        
        .dialog h3 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        .dialog-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dialog-input {
            padding: 12px;
            background-color: #444444;
            border: 1px solid #666666;
            border-radius: 4px;
            color: white;
            font-size: 14px;
        }
        
        .dialog-input::placeholder {
            color: #888888;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 20px;
        }
        
        .dialog-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            min-width: 70px;
        }
        
        .cancel-btn {
            background-color: #666666;
            color: white;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
            margin-right: auto;
        }
        
        .save-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .pins-grid {
                display: flex;
                flex-wrap: nowrap;
                gap: 2px;
            }
            
            .pin-btn {
                height: 70px;
                font-size: 14px;
                min-width: 0;
                padding: 0 2px;
                border-radius: 4px;
            }
            
            .address-display {
                font-size: 28px;
                height: 70px;
            }
            
            .round-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .address-group {
                flex-direction: row;
                gap: 4px;
            }
            
            .address-group span {
                font-size: 11px;
            }
            
            .number-input {
                width: 90px;
                height: 55px;
                font-size: 15px;
            }
            
            .input-label {
                font-size: 15px;
                width: 55px;
            }
        }
        
        @media (max-width: 350px) {
            .pin-btn {
                height: 65px;
                font-size: 13px;
            }
            
            .address-display {
                font-size: 24px;
                height: 60px;
            }
            
            .round-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .number-input {
                width: 80px;
                height: 50px;
                font-size: 14px;
            }
            
            .input-label {
                font-size: 14px;
                width: 50px;
            }
        }
        
        /* ЗАГРУЗЧИК */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        /* СКРОЛЛБАР */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #222;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- ОСНОВНОЙ ИНТЕРФЕЙС -->
    <div class="app-container">
        <!-- Панель оборудования -->
        <div class="equipment-header">
            <button class="equipment-toggle" onclick="toggleEquipmentList()">
                ОБОРУДОВАНИЕ ▼
            </button>
        </div>

        <!-- Закрепленное оборудование -->
        <div id="pinned-container" class="pinned-container"></div>

        <!-- Отображение адреса -->
        <div class="address-section">
            <div class="address-controls">
                <button class="round-btn minus-btn" onclick="decreaseAddress()">-</button>
                <div id="address-display" class="address-display">1</div>
                <button class="round-btn plus-btn" onclick="increaseAddress()">+</button>
            </div>

            <div class="surrounding-addresses">
                <div class="address-group" id="prev-addresses"></div>
                <div class="arrows">
                    <span class="arrow">←</span>
                    <div class="empty-space"></div>
                    <span class="arrow">→</span>
                </div>
                <div class="address-group" id="next-addresses"></div>
            </div>
        </div>

        <!-- Ввод шага и адреса -->
        <div class="input-section">
            <div class="input-row">
                <span class="input-label">ШАГ:</span>
                <input type="number" id="step-input" class="number-input" value="1" min="1" max="512" onchange="updateStepValue()">
            </div>
            <div class="input-row">
                <span class="input-label">АДРЕС:</span>
                <input type="number" id="address-input" class="number-input" value="1" min="1" max="512" onchange="setPinsFromAddress()">
            </div>
        </div>

        <div class="divider"></div>

        <!-- Кнопки пинов -->
        <div class="pins-section">
            <div class="pins-grid" id="pins-container"></div>
        </div>

        <!-- Результат -->
        <div id="result-text" class="result-text">
            Адрес: 1<br>Пины: нет
        </div>

        <!-- Кнопка сброса -->
        <button class="reset-btn" onclick="resetAll()">СБРОСИТЬ ВСЕ</button>

        <!-- Панель оборудования (скрытая) -->
        <div id="equipment-panel" class="equipment-panel">
            <div class="equipment-panel-header">
                <button class="close-btn" onclick="toggleEquipmentList()">
                    ✕ ЗАКРЫТЬ
                </button>
            </div>

            <input type="text" id="equipment-search" class="search-input" 
                   placeholder="Поиск оборудования..." oninput="filterEquipment(this.value)">

            <button class="add-equipment-btn" onclick="showAddEquipmentDialog()">
                + ДОБАВИТЬ ПРИБОР
            </button>

            <div class="equipment-list-container" id="equipment-list-container">
                <!-- Список оборудования будет здесь -->
            </div>
        </div>
    </div>

    <!-- Диалог добавления/редактирования оборудования -->
    <div id="equipment-dialog" class="dialog-overlay">
        <div class="dialog">
            <h3 id="dialog-title">Добавить прибор</h3>
            <div class="dialog-content">
                <input type="text" id="dialog-name" class="dialog-input" placeholder="Название прибора">
                <input type="text" id="dialog-power" class="dialog-input" placeholder="Мощность (например: 1000W, 500W, DIM)">
                <input type="text" id="dialog-channels" class="dialog-input" placeholder="DMX каналы (через /, например: 16/20 или DIM)">
            </div>
            <div class="dialog-buttons">
                <button class="dialog-btn cancel-btn" onclick="closeEquipmentDialog()">Отмена</button>
                <button class="dialog-btn delete-btn" id="delete-btn" style="display: none;" onclick="deleteEquipment()">Удалить</button>
                <button class="dialog-btn save-btn" onclick="saveEquipment()">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Загрузчик -->
    <div id="loader" class="loader">Загрузка...</div>

    <script>
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        let dmxApp = null;
        let lastClickTime = 0;
        const CLICK_DELAY = 300;

        // Функция для предотвращения быстрых повторных кликов
        function throttleClick(callback) {
            const now = Date.now();
            if (now - lastClickTime > CLICK_DELAY) {
                lastClickTime = now;
                return callback();
            }
            return false;
        }

        // КЛАСС DMX КАЛЬКУЛЯТОРА
        class EquipmentItem {
            constructor(name, power, channels, pinned = false, isCustom = false) {
                this.name = name;
                this.power = power;
                this.channels = channels;
                this.pinned = pinned;
                this.isCustom = isCustom;
            }

            toString() {
                return `${this.name} ${this.power} ${this.channels}ch`;
            }

            toStorageString() {
                return `${this.name}||${this.power}||${this.channels}||${this.pinned}||${this.isCustom}`;
            }

            static fromStorageString(storageString) {
                const parts = storageString.split('||');
                if (parts.length === 5) {
                    return new EquipmentItem(
                        parts[0],
                        parts[1],
                        parts[2],
                        parts[3] === 'true',
                        parts[4] === 'true'
                    );
                }
                return null;
            }

            getFirstChannel() {
                if (!this.channels || this.channels === '0' || 
                    this.channels === 'DIM' || this.channels === 'Пульт ДУ') {
                    return 0;
                }
                try {
                    const firstChannel = this.channels.split('/')[0];
                    return parseInt(firstChannel.trim());
                } catch (e) {
                    return 0;
                }
            }
        }

        class DmxCalculator {
            constructor() {
                this.DMX_TOTAL_CHANNELS = 512;
                this.currentStep = 1;
                this.currentAddress = 1;
                this.pinSelected = Array(9).fill(false);
                this.allEquipment = [];
                this.pinnedEquipment = [];
                this.editingEquipment = null;
                
                this.initializeEquipment();
                this.loadFromStorage();
                this.initializeUI();
                this.updateUI();
                
                // Инициализация полноэкранного режима
                this.initFullscreen();
            }

            initFullscreen() {
                // Автоматически скрываем адресную строку на мобильных устройствах
                if (this.isMobileDevice()) {
                    setTimeout(() => {
                        window.scrollTo(0, 1);
                    }, 100);
                    
                    window.addEventListener('scroll', () => {
                        setTimeout(() => {
                            window.scrollTo(0, 1);
                        }, 10);
                    });
                }
            }

            isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            initializeEquipment() {
                // Clay Paky
                this.allEquipment.push(new EquipmentItem("Clay Paky Scenius Unico", "1800W", "40/44"));
                this.allEquipment.push(new EquipmentItem("Clay Paky Alfa Spot HPE 1500", "2000W", "36/40"));
                this.allEquipment.push(new EquipmentItem("Clay Paky Alfa Profile QWO 800", "1200W", "32/36"));
                this.allEquipment.push(new EquipmentItem("Clay Paky Sharpy", "350W", "16/20"));
                this.allEquipment.push(new EquipmentItem("Clay Paky Sharpy Wash 330", "550W", "19/22"));
                this.allEquipment.push(new EquipmentItem("Clay Paky Super Sharpy", "700W", "24/28"));
                this.allEquipment.push(new EquipmentItem("Clay Paky Mythos", "700W", "30/34"));
                this.allEquipment.push(new EquipmentItem("Clay Paky A.LEDA B-EYE K20", "850W", "21/35/111/148"));
                this.allEquipment.push(new EquipmentItem("Clay Paky Stormy CC", "850W", "7/10/14"));

                // Martin
                this.allEquipment.push(new EquipmentItem("Martin Mac2000 Wash", "1500W", "19/21"));
                this.allEquipment.push(new EquipmentItem("Martin Mac2000 Performance", "1500W", "28/31"));
                this.allEquipment.push(new EquipmentItem("Martin Mac2000 Profile", "1500W", "20/24"));
                this.allEquipment.push(new EquipmentItem("Martin Mac600", "750W", "10/12/14"));
                this.allEquipment.push(new EquipmentItem("Martin Mac550", "600W", "21/27"));
                this.allEquipment.push(new EquipmentItem("Martin Mac101", "123W", "8/12"));
                this.allEquipment.push(new EquipmentItem("Martin Mac Viper Performance", "1350W", "32/40"));
                this.allEquipment.push(new EquipmentItem("Martin Mac Quantum", "1020W", "17/33"));
                this.allEquipment.push(new EquipmentItem("Martin Mac Aura XB", "400W", "14/25"));
                this.allEquipment.push(new EquipmentItem("Martin Atomic 3000", "27А", "1/3/4"));

                // JBLighting
                this.allEquipment.push(new EquipmentItem("JBLighting A 7", "350W", "13/15/16/19"));
                this.allEquipment.push(new EquipmentItem("JBLighting A 12", "995W", "15/19/18/22/38"));

                // GLP
                this.allEquipment.push(new EquipmentItem("GLP IMPRESSION", "350W", "10/13/14"));

                // SHOW SOLUTIONS
                this.allEquipment.push(new EquipmentItem("SHOW SOLUTIONS V-2033", "4200W", "12"));

                // DIA Lighting
                this.allEquipment.push(new EquipmentItem("DIA Lighting LED BAR 48 RGBW", "100W", "3/4/5/6/11"));
                this.allEquipment.push(new EquipmentItem("DIA Lighting LED Battery Wash Beam", "95W", "5/9/12"));
                this.allEquipment.push(new EquipmentItem("SlimPro 18 QuadColor RGBW", "150W", "4/6/9"));
                this.allEquipment.push(new EquipmentItem("DIA Lighting IS200", "350W", "16"));

                // SGM
                this.allEquipment.push(new EquipmentItem("SGM G-spot", "1100W", "24/30"));
                this.allEquipment.push(new EquipmentItem("SGM P2", "200W", "3/6/9/12/15/22"));
                this.allEquipment.push(new EquipmentItem("SGM P5", "450W", "3/4/6/8/9/10"));
                this.allEquipment.push(new EquipmentItem("SGM Q7", "465W", "3/4/6/8"));
                this.allEquipment.push(new EquipmentItem("SGM XC-5 Color LED strobe", "360W", "1/2/3/4/6/7"));

                // THOMAS
                this.allEquipment.push(new EquipmentItem("THOMAS PixelLine 1044", "164W", "3/4/10/54/61"));
                this.allEquipment.push(new EquipmentItem("THOMAS Blinder 2 DIM", "1300W", "1"));
                this.allEquipment.push(new EquipmentItem("THOMAS Blinder 4 DIM", "2600W", "1"));
                this.allEquipment.push(new EquipmentItem("THOMAS Blinder 8 DIM", "5200W", "1"));

                // RGB Lines
                this.allEquipment.push(new EquipmentItem("RGB Line350", "50W", "0"));
                this.allEquipment.push(new EquipmentItem("RGB Line1000", "150W", "0"));

                // ShowTec
                this.allEquipment.push(new EquipmentItem("ShowTec EventSpot 1900", "45W", "3/4/5/10"));
                this.allEquipment.push(new EquipmentItem("ShowTec Blinder 2DMX", "1300W", "1"));
                this.allEquipment.push(new EquipmentItem("ShowTec Blinder 4DMX", "2600W", "2"));
                this.allEquipment.push(new EquipmentItem("ShowTec Blinder 8DMX", "5200W", "4"));
                this.allEquipment.push(new EquipmentItem("ShowTec Matrix 5*5 Blinder", "1900W", "4/9/25/29"));
                this.allEquipment.push(new EquipmentItem("ShowTec Sunstrip Active", "800W", "1/2/5/10"));
                this.allEquipment.push(new EquipmentItem("ShowTec Cobra Strip", "500W", "1/2/5/10"));

                // BRITEQ
                this.allEquipment.push(new EquipmentItem("BRITEQ POWERMATRIX 5*5-RGB Mk2", "750W", "4/5/6/11/25/75/81/100/106/125/131"));
                this.allEquipment.push(new EquipmentItem("BRITEQ BT-VINTAGE", "980W", "5/6/7"));

                // LL
                this.allEquipment.push(new EquipmentItem("LL Stage Beam 6 Led", "55W", "6"));

                // AMERICAN DJ
                this.allEquipment.push(new EquipmentItem("AMERICAN DJ REVO III LED", "50W", "4/10"));

                // ETC
                this.allEquipment.push(new EquipmentItem("ETC Sours Four 26", "575W", "DIM"));
                this.allEquipment.push(new EquipmentItem("ETC Sours Four JR 36", "575W", "DIM"));
                this.allEquipment.push(new EquipmentItem("ETC Sours Four Zoom 15-30", "575W", "DIM"));
                this.allEquipment.push(new EquipmentItem("ETC Sours Four Zoom 25-50", "750W", "DIM"));

                // Arri
                this.allEquipment.push(new EquipmentItem("Arri Studio 2000", "2000W", "DIM"));

                // PAR Fixtures
                this.allEquipment.push(new EquipmentItem("Par 16", "50W", "DIM"));
                this.allEquipment.push(new EquipmentItem("Par 38", "90W", "DIM"));
                this.allEquipment.push(new EquipmentItem("Par 56", "300W", "DIM"));
                this.allEquipment.push(new EquipmentItem("Par 64", "1000W", "DIM"));
                this.allEquipment.push(new EquipmentItem("Bar 6 *Par 64", "6000W", "DIM"));

                // EUROLITE
                this.allEquipment.push(new EquipmentItem("EUROLITE LED Par-56 floor36", "16W", "5"));
                this.allEquipment.push(new EquipmentItem("EUROLITE LED Par-64 spot36", "32W", "6"));

                // COEMAR
                this.allEquipment.push(new EquipmentItem("COEMAR PAR Lite LED Silver", "55W", "6"));
                this.allEquipment.push(new EquipmentItem("COEMAR PIN Lite LED Silver", "54W", "6"));
                this.allEquipment.push(new EquipmentItem("COEMAR PANORAMA CYC POWER", "575W", "6"));

                // GRIVEN
                this.allEquipment.push(new EquipmentItem("GRIVEN KALEIDO", "650W", "5"));
                this.allEquipment.push(new EquipmentItem("GRIVEN KOLORADO", "2800W", "5"));

                // Desisti
                this.allEquipment.push(new EquipmentItem("Desisti softlight 3111", "2000W", "0"));

                // Studio Due
                this.allEquipment.push(new EquipmentItem("Studio Due space flower", "3000W", "0"));
                this.allEquipment.push(new EquipmentItem("Studio Due C34", "1100W", "13/15/20"));

                // Sky
                this.allEquipment.push(new EquipmentItem("Sky Rose 4000w", "4100W", "0"));
                this.allEquipment.push(new EquipmentItem("Light Sky ip3000", "628W", "20/24"));
                this.allEquipment.push(new EquipmentItem("Light Sky TX1810 Zoom", "246W", "10/16/20/24"));

                // Color imagination
                this.allEquipment.push(new EquipmentItem("Color imagination Si-171 minispot 250 Z", "290W", "14/16/18"));

                // Robert Juliat
                this.allEquipment.push(new EquipmentItem("Robert Juliat Aramis", "2500W", "0"));
                this.allEquipment.push(new EquipmentItem("Robert Juliat Viktor", "1800W", "0"));
                this.allEquipment.push(new EquipmentItem("Robert Juliat Flo", "1800W", "0"));

                // LDR
                this.allEquipment.push(new EquipmentItem("LDR Canto 1200", "1200W", "0"));
                this.allEquipment.push(new EquipmentItem("LDR Canto 2000FF", "2000W", "0"));

                // Fog/Haze Machines
                this.allEquipment.push(new EquipmentItem("TourHazer", "1600W", "2"));
                this.allEquipment.push(new EquipmentItem("DF-50", "437W", "1"));
                this.allEquipment.push(new EquipmentItem("JEM TECHNOHAZE", "600W", "Пульт ДУ"));
                this.allEquipment.push(new EquipmentItem("JEM TECHNOFOG", "750W", "Пульт ДУ"));
                this.allEquipment.push(new EquipmentItem("ZR 33", "1500W", "1"));
                this.allEquipment.push(new EquipmentItem("MDG ATMOSPHERE APS H.O.", "1415W", "2"));
            }

            initializeUI() {
                const pinsContainer = document.getElementById('pins-container');
                for (let i = 0; i < 9; i++) {
                    const button = document.createElement('button');
                    button.className = 'pin-btn';
                    button.textContent = (i + 1).toString();
                    button.dataset.index = i;
                    button.onclick = () => throttleClick(() => this.togglePin(i));
                    pinsContainer.appendChild(button);
                }

                this.updateSurroundingAddresses();
                this.updateEquipmentList();
                this.updatePinnedList();
            }

            normalizeAddress(address) {
                let normalized = ((address - 1) % this.DMX_TOTAL_CHANNELS);
                if (normalized < 0) {
                    normalized += this.DMX_TOTAL_CHANNELS;
                }
                return normalized + 1;
            }

            getNextAddress(current, step) {
                return this.normalizeAddress(current + step);
            }

            getPrevAddress(current, step) {
                return this.normalizeAddress(current - step);
            }

            increaseAddress() {
                return throttleClick(() => {
                    const step = parseInt(document.getElementById('step-input').value) || 1;
                    this.currentStep = step;
                    this.currentAddress = this.getNextAddress(this.currentAddress, this.currentStep);
                    this.updateUI();
                });
            }

            decreaseAddress() {
                return throttleClick(() => {
                    const step = parseInt(document.getElementById('step-input').value) || 1;
                    this.currentStep = step;
                    this.currentAddress = this.getPrevAddress(this.currentAddress, this.currentStep);
                    this.updateUI();
                });
            }

            updateStepValue() {
                const step = parseInt(document.getElementById('step-input').value) || 1;
                this.currentStep = step;
                this.updateSurroundingAddresses();
            }

            togglePin(index) {
                this.pinSelected[index] = !this.pinSelected[index];
                
                let newAddress = 0;
                for (let i = 0; i < 9; i++) {
                    if (this.pinSelected[i]) {
                        newAddress += Math.pow(2, i);
                    }
                }
                
                this.currentAddress = newAddress === 0 ? 1 : newAddress;
                this.updateUI();
            }

            updateResult() {
                const addr = this.currentAddress;
                const addressDisplay = document.getElementById('address-display');
                const addressInput = document.getElementById('address-input');
                
                if (addressDisplay) {
                    addressDisplay.textContent = addr;
                }
                
                if (addressInput) {
                    addressInput.value = addr;
                }

                const pinButtons = document.querySelectorAll('.pin-btn');
                pinButtons.forEach((btn, i) => {
                    const bit = Math.pow(2, i);
                    this.pinSelected[i] = (addr & bit) !== 0;
                    btn.classList.toggle('selected', this.pinSelected[i]);
                });

                let pinsText = "Пины: ";
                const selectedPins = [];
                for (let i = 0; i < 9; i++) {
                    if (this.pinSelected[i]) {
                        selectedPins.push(i + 1);
                    }
                }
                pinsText += selectedPins.length > 0 ? selectedPins.join(',') : 'нет';

                const resultText = document.getElementById('result-text');
                if (resultText) {
                    resultText.innerHTML = `Адрес: ${addr}<br>${pinsText}`;
                }
                
                this.updateSurroundingAddresses();
                this.saveToStorage();
            }

            setPinsFromAddress() {
                const addressInput = document.getElementById('address-input');
                let addr = parseInt(addressInput.value) || 1;
                
                addr = this.normalizeAddress(addr);
                this.currentAddress = addr;
                
                this.updateUI();
            }

            updateSurroundingAddresses() {
                const prevContainer = document.getElementById('prev-addresses');
                const nextContainer = document.getElementById('next-addresses');
                
                prevContainer.innerHTML = '';
                nextContainer.innerHTML = '';

                for (let i = 0; i < 3; i++) {
                    const stepsBack = (3 - i) * this.currentStep;
                    const prevAddress = this.getPrevAddress(this.currentAddress, stepsBack);
                    const span = document.createElement('span');
                    span.textContent = prevAddress;
                    prevContainer.appendChild(span);
                }

                for (let i = 0; i < 3; i++) {
                    const stepsForward = (i + 1) * this.currentStep;
                    const nextAddress = this.getNextAddress(this.currentAddress, stepsForward);
                    const span = document.createElement('span');
                    span.textContent = nextAddress;
                    nextContainer.appendChild(span);
                }
            }

            resetAll() {
                return throttleClick(() => {
                    this.currentStep = 1;
                    this.currentAddress = 1;
                    this.pinSelected = Array(9).fill(false);
                    
                    document.getElementById('step-input').value = "1";
                    document.getElementById('address-input').value = "1";
                    
                    this.updateUI();
                });
            }

            updateUI() {
                document.getElementById('address-display').textContent = this.currentAddress;
                document.getElementById('address-input').value = this.currentAddress;
                
                this.updateResult();
                this.updateSurroundingAddresses();
            }

            toggleEquipmentList() {
                return throttleClick(() => {
                    const panel = document.getElementById('equipment-panel');
                    const toggleBtn = document.querySelector('.equipment-toggle');
                    
                    if (panel.style.display === 'none' || panel.style.display === '') {
                        panel.style.display = 'block';
                        toggleBtn.textContent = 'ОБОРУДОВАНИЕ ▲';
                        this.updateEquipmentList();
                    } else {
                        panel.style.display = 'none';
                        toggleBtn.textContent = 'ОБОРУДОВАНИЕ ▼';
                        document.getElementById('equipment-search').value = '';
                    }
                });
            }

            updateEquipmentList() {
                const container = document.getElementById('equipment-list-container');
                const searchTerm = document.getElementById('equipment-search').value.toLowerCase();
                
                container.innerHTML = '';
                
                this.allEquipment.forEach((item, index) => {
                    if (searchTerm && !item.name.toLowerCase().includes(searchTerm) &&
                        !item.power.toLowerCase().includes(searchTerm) &&
                        !item.channels.toLowerCase().includes(searchTerm)) {
                        return;
                    }
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'equipment-item';
                    
                    const textDiv = document.createElement('div');
                    textDiv.className = 'equipment-item-text';
                    textDiv.textContent = item.toString();
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.textContent = '✎';
                    editBtn.onclick = () => throttleClick(() => this.showEditEquipmentDialog(item));
                    
                    const pinBtn = document.createElement('button');
                    pinBtn.className = `pin-star-btn ${item.pinned ? 'pinned' : ''}`;
                    pinBtn.textContent = item.pinned ? '★' : '☆';
                    pinBtn.onclick = () => throttleClick(() => this.togglePinEquipment(item));
                    
                    itemDiv.appendChild(textDiv);
                    itemDiv.appendChild(editBtn);
                    itemDiv.appendChild(pinBtn);
                    container.appendChild(itemDiv);
                });
            }

            updatePinnedList() {
                const container = document.getElementById('pinned-container');
                container.innerHTML = '';
                
                if (this.pinnedEquipment.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                
                container.style.display = 'block';
                
                this.pinnedEquipment.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'pinned-item';
                    
                    const textDiv = document.createElement('div');
                    textDiv.className = 'pinned-item-text';
                    textDiv.textContent = `${item.name} - ${item.power}, ${item.channels}ch`;
                    
                    const unpinBtn = document.createElement('button');
                    unpinBtn.className = 'unpin-btn';
                    unpinBtn.textContent = '✕';
                    unpinBtn.onclick = () => throttleClick(() => this.togglePinEquipment(item));
                    
                    itemDiv.appendChild(textDiv);
                    itemDiv.appendChild(unpinBtn);
                    container.appendChild(itemDiv);
                });
            }

            filterEquipment(searchTerm) {
                this.updateEquipmentList();
            }

            showAddEquipmentDialog() {
                return throttleClick(() => {
                    this.editingEquipment = null;
                    document.getElementById('dialog-title').textContent = 'Добавить прибор';
                    document.getElementById('delete-btn').style.display = 'none';
                    document.getElementById('dialog-name').value = '';
                    document.getElementById('dialog-power').value = '';
                    document.getElementById('dialog-channels').value = '';
                    document.getElementById('equipment-dialog').style.display = 'flex';
                    
                    setTimeout(() => {
                        document.getElementById('dialog-name').focus();
                    }, 100);
                });
            }

            showEditEquipmentDialog(item) {
                this.editingEquipment = item;
                document.getElementById('dialog-title').textContent = 'Редактировать прибор';
                document.getElementById('delete-btn').style.display = item.isCustom ? 'block' : 'none';
                document.getElementById('dialog-name').value = item.name;
                document.getElementById('dialog-power').value = item.power;
                document.getElementById('dialog-channels').value = item.channels;
                document.getElementById('equipment-dialog').style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('dialog-name').focus();
                }, 100);
            }

            closeEquipmentDialog() {
                document.getElementById('equipment-dialog').style.display = 'none';
            }

            saveEquipment() {
                const name = document.getElementById('dialog-name').value.trim();
                const power = document.getElementById('dialog-power').value.trim();
                const channels = document.getElementById('dialog-channels').value.trim();
                
                if (!name || !power || !channels) {
                    alert('Пожалуйста, заполните все поля');
                    return;
                }
                
                if (this.editingEquipment) {
                    this.editingEquipment.name = name;
                    this.editingEquipment.power = power;
                    this.editingEquipment.channels = channels;
                    if (!this.editingEquipment.isCustom) {
                        this.editingEquipment.isCustom = true;
                    }
                } else {
                    const newItem = new EquipmentItem(name, power, channels, false, true);
                    this.allEquipment.push(newItem);
                }
                
                this.saveToStorage();
                this.updateEquipmentList();
                this.updatePinnedList();
                this.closeEquipmentDialog();
                
                this.toggleEquipmentList();
                this.toggleEquipmentList();
            }

            deleteEquipment() {
                if (!this.editingEquipment || !this.editingEquipment.isCustom) return;
                
                if (!confirm(`Удалить прибор "${this.editingEquipment.name}"?`)) {
                    return;
                }
                
                const index = this.allEquipment.indexOf(this.editingEquipment);
                if (index > -1) {
                    this.allEquipment.splice(index, 1);
                }
                
                const pinnedIndex = this.pinnedEquipment.indexOf(this.editingEquipment);
                if (pinnedIndex > -1) {
                    this.pinnedEquipment.splice(pinnedIndex, 1);
                }
                
                this.saveToStorage();
                this.updateEquipmentList();
                this.updatePinnedList();
                this.closeEquipmentDialog();
            }

            togglePinEquipment(item) {
                item.pinned = !item.pinned;
                
                if (item.pinned) {
                    if (!this.pinnedEquipment.includes(item)) {
                        this.pinnedEquipment.push(item);
                    }
                } else {
                    const index = this.pinnedEquipment.indexOf(item);
                    if (index > -1) {
                        this.pinnedEquipment.splice(index, 1);
                    }
                }
                
                this.saveToStorage();
                this.updateEquipmentList();
                this.updatePinnedList();
            }

            saveToStorage() {
                try {
                    const customItems = this.allEquipment.filter(item => item.isCustom);
                    const customData = customItems.map(item => item.toStorageString());
                    localStorage.setItem('dmx_custom_equipment', JSON.stringify(customData));
                    
                    const pinnedData = this.pinnedEquipment.map(item => item.toStorageString());
                    localStorage.setItem('dmx_pinned_equipment', JSON.stringify(pinnedData));
                    
                    const settings = {
                        step: this.currentStep,
                        address: this.currentAddress,
                        pins: this.pinSelected
                    };
                    localStorage.setItem('dmx_settings', JSON.stringify(settings));
                } catch (e) {
                    console.error('Ошибка сохранения данных:', e);
                }
            }

            loadFromStorage() {
                try {
                    const customData = JSON.parse(localStorage.getItem('dmx_custom_equipment') || '[]');
                    customData.forEach(storageString => {
                        const item = EquipmentItem.fromStorageString(storageString);
                        if (item) {
                            this.allEquipment.push(item);
                        }
                    });
                    
                    const pinnedData = JSON.parse(localStorage.getItem('dmx_pinned_equipment') || '[]');
                    pinnedData.forEach(storageString => {
                        const savedItem = EquipmentItem.fromStorageString(storageString);
                        if (savedItem) {
                            const existingItem = this.allEquipment.find(item => 
                                item.name === savedItem.name &&
                                item.power === savedItem.power &&
                                item.channels === savedItem.channels
                            );
                            
                            if (existingItem) {
                                existingItem.pinned = true;
                                this.pinnedEquipment.push(existingItem);
                            } else if (savedItem.isCustom) {
                                savedItem.pinned = true;
                                this.allEquipment.push(savedItem);
                                this.pinnedEquipment.push(savedItem);
                            }
                        }
                    });
                    
                    const settings = JSON.parse(localStorage.getItem('dmx_settings') || '{}');
                    if (settings.step) {
                        this.currentStep = settings.step;
                        document.getElementById('step-input').value = settings.step;
                    }
                    if (settings.address) {
                        this.currentAddress = settings.address;
                        document.getElementById('address-input').value = settings.address;
                    }
                    if (settings.pins) {
                        this.pinSelected = settings.pins;
                    }
                } catch (e) {
                    console.error('Ошибка загрузки данных:', e);
                }
            }
        }

        // ГЛОБАЛЬНЫЕ ФУНКЦИИ
        function increaseAddress() {
            if (dmxApp) {
                dmxApp.increaseAddress();
            }
        }

        function decreaseAddress() {
            if (dmxApp) {
                dmxApp.decreaseAddress();
            }
        }

        function resetAll() {
            if (dmxApp) dmxApp.resetAll();
        }

        function updateStepValue() {
            if (dmxApp) dmxApp.updateStepValue();
        }

        function setPinsFromAddress() {
            if (dmxApp) dmxApp.setPinsFromAddress();
        }

        function toggleEquipmentList() {
            if (dmxApp) dmxApp.toggleEquipmentList();
        }

        function showAddEquipmentDialog() {
            if (dmxApp) dmxApp.showAddEquipmentDialog();
        }

        function closeEquipmentDialog() {
            if (dmxApp) dmxApp.closeEquipmentDialog();
        }

        function saveEquipment() {
            if (dmxApp) dmxApp.saveEquipment();
        }

        function deleteEquipment() {
            if (dmxApp) dmxApp.deleteEquipment();
        }

        function filterEquipment(value) {
            if (dmxApp) dmxApp.filterEquipment(value);
        }

        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        document.addEventListener('DOMContentLoaded', () => {
            // Инициализация калькулятора
            dmxApp = new DmxCalculator();
            
            // Сохранять данные при закрытии страницы
            window.addEventListener('beforeunload', () => {
                if (dmxApp) {
                    dmxApp.saveToStorage();
                }
            });
        });

        // Обработка клавиатуры для диалогов
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const dialog = document.getElementById('equipment-dialog');
                if (dialog.style.display === 'flex') {
                    closeEquipmentDialog();
                }
            }
            
            if (e.key === 'Enter' && document.getElementById('equipment-dialog').style.display === 'flex') {
                const active = document.activeElement;
                if (active && (active.id === 'dialog-name' || active.id === 'dialog-power' || active.id === 'dialog-channels')) {
                    e.preventDefault();
                    if (active.id === 'dialog-name') {
                        document.getElementById('dialog-power').focus();
                    } else if (active.id === 'dialog-power') {
                        document.getElementById('dialog-channels').focus();
                    } else if (active.id === 'dialog-channels') {
                        saveEquipment();
                    }
                }
            }
        });
    </script>
</body>
</html>
